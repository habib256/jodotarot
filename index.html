<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tirage de Tarot en Croix</title>
  <style>
    body { 
      font-family: sans-serif; 
      text-align: center; 
      margin: 0;
      padding: 0;
    }
    /* Ent√™te avec logo et question */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      margin-bottom: 20px;
      position: relative;
    }
    .left-side-container {
      display: flex;
      align-items: center;
      gap: 20px;
      flex: 0 0 auto;
    }
    .logo-container {
      display: flex;
      justify-content: center;
      flex: 0 0 auto;
      margin-left: 10px;
      margin-right: 20px;
    }
    .logo-container img {
      height: 305px;
      width: auto;
    }
    .selection-controls {
      position: static;
      transform: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 10;
      text-align: left;
      flex: 0 0 auto;
      min-width: 220px;
    }
    .header-question {
      flex: 1;
      text-align: left;
      margin-left: 20px;
      margin-right: 15px;
    }
    /* Conteneur principal en deux colonnes */
    .container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
      margin: 10px;
    }
    .left-panel {
      flex: 1;
      min-width: 300px;
      text-align: left;
      padding: 10px;
      border-right: 1px solid #ccc;
    }
    .right-panel {
      width: 550px; /* R√©duit par rapport √† la version pr√©c√©dente (650px) */
      flex: 0 0 auto; /* Ne pas r√©tr√©cir ni agrandir */
      padding: 10px;
      position: relative;
      min-height: 550px; /* L√©g√®rement r√©duit */
      display: flex;
      justify-content: center;
      align-items: center;
    }
    /* Grille de la croix */
    .spread {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      grid-template-rows: auto auto auto;
      grid-template-areas: 
        ". top ."
        "left center right"
        ". bottom .";
      column-gap: 8px; /* L√©g√®rement r√©duit */
      row-gap: 8px; /* L√©g√®rement r√©duit */
      width: 100%;
      max-width: 500px; /* R√©duit par rapport √† la version pr√©c√©dente (600px) */
      margin: 5px auto;
      position: relative;
    }
    .top { grid-area: top; justify-self: center; }
    .left { grid-area: left; }
    .center { grid-area: center; }
    .right { grid-area: right; }
    .bottom { grid-area: bottom; justify-self: center; }
    .card { 
      width: 100%; 
      max-width: 130px; /* R√©duit de 150px √† 130px */
      cursor: pointer;
      transition: transform 0.3s ease;
      transform-origin: center center;
      position: relative;
      z-index: 1;
    }
    .card.enlarged {
      position: fixed;
      top: 0;
      left: 0;
      width: 580px; /* Augment√© de 550px √† 580px (+ 30px) */
      height: 100%;
      max-width: none;
      max-height: none;
      z-index: 1000;
      object-fit: contain;
      padding: 20px;
      box-sizing: border-box;
      background-color: rgba(0, 0, 0, 0.7);
    }
    button { padding: 10px 20px; font-size: 16px; margin-top: 20px; }
    .input-group {
      margin-bottom: 15px;
    }
    .question-input {
      width: 100%; /* Chang√© de 90% √† 100% pour utiliser tout l'espace disponible dans header-question */
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      min-height: 50px;
      resize: vertical;
      font-family: inherit;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    #interpretations {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f8f8;
      border-radius: 5px;
      border-left: 3px solid #6b5b95;
    }
    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
    }
    /* Styles pour les nouveaux √©l√©ments */
    .controls-container {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }
    .select-group {
      position: relative;
      width: 100%;
      max-width: 220px;
    }
    .select-dropdown {
      padding: 9px 15px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: white;
      appearance: none;
      cursor: pointer;
      width: 100%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    
    .select-dropdown:hover {
      border-color: #6b5b95;
      box-shadow: 0 2px 6px rgba(107, 91, 149, 0.2);
    }
    
    .select-dropdown:focus {
      outline: none;
      border-color: #6b5b95;
      box-shadow: 0 0 0 3px rgba(107, 91, 149, 0.25);
    }
    .select-group::after {
      content: '‚ñº';
      font-size: 10px;
      color: #666;
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
    }
    /* √âtiquettes pour les menus d√©roulants */
    .select-label {
      display: block;
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 3px;
      color: #444;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="left-side-container">
      <!-- Menus d√©roulants √† gauche -->
      <div class="selection-controls">
        <div class="select-group">
          <span class="select-label">Personnage :</span>
          <select id="persona" class="select-dropdown">
            <optgroup label="Arts Divinatoires">
              <option value="tarologue">üîÆ Tarologue</option>
              <option value="oracle">‚ú® Oracle Mystique</option>
              <option value="voyante">üéØ Voyante Gitane</option>
            </optgroup>
            <optgroup label="Traditions Spirituelles">
              <option value="pretre">‚úùÔ∏è Pr√™tre Ex√©g√®te</option>
              <option value="rabbin">‚ú°Ô∏è Rabbin Kabbaliste</option>
              <option value="imam">‚ò™Ô∏è Imam Soufis</option>
            </optgroup>
            <optgroup label="Traditions √âsot√©riques">
              <option value="sorciere">üåô Sorci√®re Ancestrale</option>
              <option value="alchimiste">‚öóÔ∏è Alchimiste √âsot√©rique</option>
              <option value="mage">üåü Mage √âl√©mentaliste</option>
            </optgroup>
            <optgroup label="Psychanalystes">
              <option value="freud">üõãÔ∏è Sigmund Freud</option>
              <option value="jung">‚òØÔ∏è Carl Gustav Jung</option>
              <option value="lacan">üîÑ Jacques Lacan</option>
              <option value="dolto">üë∂ Fran√ßoise Dolto</option>
            </optgroup>
            <optgroup label="Entit√©s Surnaturelles">
              <option value="demon">üòà D√©mon des Pactes</option>
            </optgroup>
          </select>
        </div>
        
        <div class="select-group">
          <span class="select-label">Jeu de cartes :</span>
          <select id="card-set" class="select-dropdown">
            <option value="set01" selected>Tarot de Marseille</option>
            <option value="set02">Tarot Thiago Lehmann</option>
          </select>
        </div>
        
        <div class="select-group">
          <span class="select-label">Mod√®le d'IA :</span>
          <select id="ia-model" class="select-dropdown">
            <optgroup label="OpenAI">
              <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
              <option value="openai/gpt-3.5-turbo" selected>GPT-3.5 Turbo</option>
              <option value="openai/gpt-4o">GPT-4o</option>
            </optgroup>
            <optgroup label="Ollama">
              <!-- Les mod√®les Ollama seront charg√©s dynamiquement au d√©marrage -->
              <option value="" disabled>Chargement des mod√®les...</option>
            </optgroup>
          </select>
        </div>
      </div>
      
      <!-- Logo persona juste √† c√¥t√© des menus -->
      <div class="logo-container">
        <img id="persona-logo" src="personas/tarologue.png" style="width: 210%;" alt="Persona Tarologue" />
      </div>
    </div>
    
    <!-- Question et bouton √† droite -->
    <div class="header-question">
      <div class="input-group">
        <label for="question">Votre question :</label>
        <textarea id="question" placeholder="Entrez votre question pour ce tirage..." class="question-input" rows="2"></textarea>
      </div>
      <div class="controls-container">
        <button id="tirer">Tirer les cartes</button>
      </div>
    </div>
  </div>
  
  <!-- Ligne de s√©paration entre le haut et le bas de la page -->
  <hr style="width: 95%; margin: 0 auto 20px auto; border: 0; height: 1px; background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(107, 91, 149, 0.75), rgba(0, 0, 0, 0));">
  
  <div class="container">
    <div class="right-panel">
      <div id="spread" class="spread">
        <div class="top"></div>
        <div class="left"></div>
        <div class="center"></div>
        <div class="right"></div>
        <div class="bottom"></div>
      </div>
    </div>
    <div class="left-panel">
      <div id="interpretations">
        <p>Les interpr√©tations s'afficheront ici apr√®s le tirage.</p>
      </div>
    </div>
  </div>

  <!-- Import du module model.js -->
  <script type="module">
    import { obtenirReponseGPT4O, obtenirModelesOllama } from './model.js';

    // Tableau des cartes du tarot avec les chemins vers les images
    const cardsData = {
      set01: [
        { id: "00", name: "Le fou", image: "set01/00 Le fou.png" },
        { id: "01", name: "Bateleur", image: "set01/01 Bateleur.png" },
        { id: "02", name: "Papesse", image: "set01/02 Papesse.png" },
        { id: "03", name: "Imperatrice", image: "set01/03 Imperatrice.png" },
        { id: "04", name: "Empereur", image: "set01/04 Empereur.png" },
        { id: "05", name: "Pape", image: "set01/05 Pape.png" },
        { id: "06", name: "Les amoureux", image: "set01/06 Les amoureux.png" },
        { id: "07", name: "Chariot", image: "set01/07 Chariot.png" },
        { id: "08", name: "Justice", image: "set01/08 Justice.png" },
        { id: "09", name: "Ermite", image: "set01/09 Ermite.png" },
        { id: "10", name: "La roue", image: "set01/10 La roue.png" },
        { id: "11", name: "Force", image: "set01/11 Force.png" },
        { id: "12", name: "Le pendu", image: "set01/12 Le pendu.png" },
        { id: "13", name: "La mort", image: "set01/13 La mort.png" },
        { id: "14", name: "Temperance", image: "set01/14 Temperance.png" },
        { id: "15", name: "Diable", image: "set01/15 Diable.png" },
        { id: "16", name: "La Tour", image: "set01/16 La Tour.png" },
        { id: "17", name: "Etoile", image: "set01/17 Etoile.png" },
        { id: "18", name: "La lune", image: "set01/18 La lune.png" },
        { id: "19", name: "Le soleil", image: "set01/19 Le soleil.png" },
        { id: "20", name: "Le jugement", image: "set01/20 Le jugement.png" },
        { id: "21", name: "Le monde", image: "set01/21 Le monde.png" },
        { id: "22", name: "Dos de carte", image: "set01/22 Dos de carte.png" }
      ],
      set02: [
        { id: "00", name: "Le fou", image: "set02/00 Le fou.jpg" },
        { id: "01", name: "Bateleur", image: "set02/01 Bateleur.jpg" },
        { id: "02", name: "Papesse", image: "set02/02 Papesse.jpg" },
        { id: "03", name: "Imperatrice", image: "set02/03 Imperatrice.jpg" },
        { id: "04", name: "Empereur", image: "set02/04 Empereur.jpg" },
        { id: "05", name: "Pape", image: "set02/05 Pape.jpg" },
        { id: "06", name: "Les amoureux", image: "set02/06 Les amoureux.jpg" },
        { id: "07", name: "Chariot", image: "set02/07 Chariot.jpg" },
        { id: "08", name: "Justice", image: "set02/08 Justice.jpg" },
        { id: "09", name: "Ermite", image: "set02/09 Ermite.jpg" },
        { id: "10", name: "La roue", image: "set02/10 La roue.jpg" },
        { id: "11", name: "Force", image: "set02/11 Force.jpg" },
        { id: "12", name: "Le pendu", image: "set02/12 Le pendu.jpg" },
        { id: "13", name: "La mort", image: "set02/13 La mort.jpg" },
        { id: "14", name: "Temperance", image: "set02/14 Temperance.jpg" },
        { id: "15", name: "Diable", image: "set02/15 Diable.jpg" },
        { id: "16", name: "La Tour", image: "set02/16 La Tour.jpg" },
        { id: "17", name: "Etoile", image: "set02/17 Etoile.jpg" },
        { id: "18", name: "La lune", image: "set02/18 La lune.jpg" },
        { id: "19", name: "Le soleil", image: "set02/19 Le soleil.jpg" },
        { id: "20", name: "Le jugement", image: "set02/20 Le jugement.jpg" },
        { id: "21", name: "Le monde", image: "set02/21 Le monde.jpg" },
        { id: "22", name: "Dos de carte", image: "set02/22 Dos de carte.png" }
      ]
    };

    // Variables pour stocker le tirage actuel
    let tirageActuel = [];
    let questionActuelle = "";

    // Fonction pour m√©langer un tableau
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // Fonction pour g√©n√©rer le HTML d'une carte (uniquement l'image)
    function renderCard(card) {
      return `<img src="${card.image}" alt="${card.name}" class="card" onclick="toggleEnlarge(this)">`;
    }

    // Fonction pour initialiser le tirage en affichant le dos des cartes dans la croix
    function initSpread() {
      const jeuSelectionne = document.getElementById('card-set').value;
      const backHTML = `<img src="${cardsData[jeuSelectionne][22].image}" alt="Dos de carte" class="card">`;
      const cells = document.querySelectorAll('.top, .left, .center, .right, .bottom');
      cells.forEach(cell => cell.innerHTML = backHTML);
      
      // R√©initialiser tirageActuel
      tirageActuel = [];
    }

    // Fonction pour obtenir l'interpr√©tation du tirage via GPT-4o
    async function obtenirInterpretation(tirage, question) {
      const interpretationsDiv = document.getElementById('interpretations');
      interpretationsDiv.innerHTML = '<p class="loading">Analyse du tirage en cours...</p>';
      
      // R√©cup√©ration des options s√©lectionn√©es
      const modeleIA = document.getElementById('ia-model').value;
      const persona = document.getElementById('persona').value;
      
      // Pr√©paration de la question pour l'interpr√©tation
      const prompt = `Interpr√©tez ce tirage de tarot en croix en relation avec ma question: "${question}"`;
      
      try {
        // Affichage d'un message indiquant le mod√®le et le personnage utilis√©s
        interpretationsDiv.innerHTML = `<p class="loading">Analyse du tirage en cours avec ${modeleIA} interpr√©t√© par un(e) ${getPersonaLabel(persona)}...</p>`;
        
        // Appel √† l'API GPT-4o via notre fonction avec les options s√©lectionn√©es
        const reponse = await obtenirReponseGPT4O(prompt, [], modeleIA, persona, tirage);
        
        // Mise en forme de la r√©ponse
        const formattedResponse = reponse.split('\n').map(paragraph => 
          paragraph ? `<p>${paragraph}</p>` : ''
        ).join('');
        
        interpretationsDiv.innerHTML = formattedResponse;
      } catch (error) {
        console.error("Erreur lors de l'interpr√©tation:", error);
        interpretationsDiv.innerHTML = '<p>Une erreur est survenue lors de l\'interpr√©tation. Veuillez r√©essayer.</p>';
      }
    }
    
    // Fonction pour obtenir le libell√© d'un persona √† partir de sa valeur
    function getPersonaLabel(personaValue) {
      const personaSelect = document.getElementById('persona');
      for (let i = 0; i < personaSelect.options.length; i++) {
        if (personaSelect.options[i].value === personaValue) {
          return personaSelect.options[i].text;
        }
      }
      return "Tarologue";
    }

    // Fonction pour effectuer un tirage de 5 cartes
    function faireUnTirage() {
      // R√©cup√©rer la question
      const question = document.getElementById('question').value.trim();
      
      // V√©rifier si une question a √©t√© pos√©e
      if (!question) {
        alert("Veuillez entrer une question avant de tirer les cartes.");
        return;
      }
      
      // M√©moriser la question
      questionActuelle = question;
      
      // R√©cup√©rer le jeu de cartes s√©lectionn√©
      const jeuSelectionne = document.getElementById('card-set').value;
      
      // M√©langer les cartes (exclure la derni√®re qui est le dos de carte)
      const jeuMelange = shuffle([...cardsData[jeuSelectionne].slice(0, -1)]);
      
      // S√©lectionner les 5 premi√®res cartes pour le tirage
      tirageActuel = jeuMelange.slice(0, 5);
      
      // Afficher les cartes dans la croix
      afficherTirage();
      
      // Obtenir l'interpr√©tation
      obtenirInterpretation(tirageActuel, questionActuelle);
    }

    // Nouvelle fonction pour afficher le tirage actuel
    function afficherTirage() {
      if (tirageActuel.length !== 5) return;
      
      const positions = document.querySelectorAll('.top, .bottom, .right, .left, .center');
      positions.forEach((position, index) => {
        position.innerHTML = renderCard(tirageActuel[index]);
      });
    }

    // Fonction pour mettre √† jour l'affichage des cartes lors du changement de jeu
    function mettreAJourAffichageCartes() {
      const jeuSelectionne = document.getElementById('card-set').value;
      
      // Si un tirage est en cours, on met √† jour les images avec le nouveau jeu
      if (tirageActuel.length === 5) {
        // R√©cup√©rer les cartes correspondantes dans le nouveau jeu
        const nouvelleCartes = tirageActuel.map(carte => {
          const id = carte.id;
          return cardsData[jeuSelectionne].find(c => c.id === id);
        });
        
        // Mettre √† jour le tirage actuel
        tirageActuel = nouvelleCartes;
        
        // Afficher le tirage avec les nouvelles images
        afficherTirage();
      } else {
        // Sinon, on initialise juste l'affichage avec le dos des cartes
        initSpread();
      }
    }

    // Fonction pour agrandir/r√©duire une carte
    window.toggleEnlarge = function(img) {
      if (img.classList.contains('enlarged')) {
        // Si la carte est d√©j√† agrandie, la r√©duire
        img.classList.remove('enlarged');
        img.style.left = '';
      } else {
        // Agrandir la carte et l'aligner pr√©cis√©ment avec le panneau gauche
        img.classList.add('enlarged');
        
        // Obtenir la position et les dimensions du panneau gauche (qui est maintenant le right-panel)
        const leftPanel = document.querySelector('.right-panel');
        const leftPanelRect = leftPanel.getBoundingClientRect();
        
        // Positionner la carte agrandie exactement au-dessus du panneau gauche
        img.style.left = leftPanelRect.left + 'px';
      }
    };

    // Fonction pour mettre √† jour l'image du logo en fonction du persona s√©lectionn√©
    function updatePersonaLogo(persona) {
      const logoImg = document.getElementById('persona-logo');
      // Gestion du cas sp√©cial pour le Mage √âl√©mentaliste
      const imageName = persona === "mage" ? "elementaliste" : persona;
      logoImg.src = `personas/${imageName}.png`;
      logoImg.alt = `${getPersonaLabel(persona)}`;
    }

    // Fonction pour charger les mod√®les Ollama disponibles
    async function chargerModelesOllama() {
      try {
        const selectModele = document.getElementById('ia-model');
        const groupeOllama = selectModele.querySelector('optgroup[label="Ollama"]');
        
        // Afficher un message de chargement
        const optionChargement = document.createElement('option');
        optionChargement.textContent = "Chargement des mod√®les...";
        optionChargement.disabled = true;
        groupeOllama.appendChild(optionChargement);
        
        // R√©cup√©rer les mod√®les disponibles
        const modeles = await obtenirModelesOllama();
        
        // Supprimer le message de chargement
        groupeOllama.removeChild(optionChargement);
        
        // Supprimer les options existantes du groupe Ollama
        while (groupeOllama.firstChild) {
          groupeOllama.removeChild(groupeOllama.firstChild);
        }
        
        if (modeles.length === 0) {
          // Si aucun mod√®le n'est disponible
          const optionErreur = document.createElement('option');
          optionErreur.textContent = "Aucun mod√®le disponible";
          optionErreur.disabled = true;
          groupeOllama.appendChild(optionErreur);
        } else {
          // Ajouter les mod√®les disponibles
          modeles.forEach(modele => {
            const option = document.createElement('option');
            option.value = `ollama/${modele.name}`;
            option.textContent = modele.name;
            groupeOllama.appendChild(option);
          });
        }
      } catch (error) {
        console.error("Erreur lors du chargement des mod√®les Ollama:", error);
        
        // Mettre √† jour le groupe avec un message d'erreur
        const selectModele = document.getElementById('ia-model');
        const groupeOllama = selectModele.querySelector('optgroup[label="Ollama"]');
        
        // Supprimer les options existantes
        while (groupeOllama.firstChild) {
          groupeOllama.removeChild(groupeOllama.firstChild);
        }
        
        // Ajouter un message d'erreur
        const optionErreur = document.createElement('option');
        optionErreur.textContent = "Erreur de connexion √† Ollama";
        optionErreur.disabled = true;
        groupeOllama.appendChild(optionErreur);
      }
    }

    // Initialisation au chargement de la page
    document.addEventListener('DOMContentLoaded', () => {
      // Afficher le dos des cartes
      initSpread();
      
      // Ajouter un gestionnaire d'√©v√©nements au bouton de tirage
      document.getElementById('tirer').addEventListener('click', faireUnTirage);
      
      // Ajouter un gestionnaire d'√©v√©nements au menu d√©roulant des personas
      document.getElementById('persona').addEventListener('change', function() {
        updatePersonaLogo(this.value);
      });
      
      // Ajouter un gestionnaire d'√©v√©nements au menu d√©roulant du jeu de cartes
      document.getElementById('card-set').addEventListener('change', function() {
        mettreAJourAffichageCartes();
      });
      
      // Initialiser le logo avec le persona par d√©faut
      updatePersonaLogo(document.getElementById('persona').value);
      
      // Charger les mod√®les Ollama disponibles
      chargerModelesOllama();
    });
  </script>
</body>
</html> 