# Gestion des Interactions Utilisateur

## Vue d'Ensemble

JodoTarot implÃ©mente un systÃ¨me d'interactions utilisateur basÃ© sur une architecture Ã©vÃ©nementielle et une gestion d'Ã©tat centralisÃ©e. Le systÃ¨me est conÃ§u pour Ãªtre rÃ©actif, accessible et maintenir une cohÃ©rence entre l'Ã©tat de l'application et l'interface utilisateur.

## Services Principaux

### UIService

Le `UIService` est le service central pour la gestion des interactions UI :

```javascript
class UIService {
  constructor() {
    // Initialiser les gestionnaires d'Ã©vÃ©nements globaux
    this.initGlobalEvents();
    
    // Ã‰couter l'Ã©vÃ©nement de disponibilitÃ© de l'Ã©tat
    document.addEventListener('stateManager:ready', this.handleStateReady.bind(this));
    
    // Ã‰couter les changements globaux d'Ã©tat
    document.addEventListener('state:changed', this.handleStateChanged.bind(this));
  }
  
  handleStateReady(event) {
    console.log('ðŸ”„ UIService: Ã‰tat disponible, synchronisation de l\'interface');
    this.synchronizeUIWithState(event.detail.state);
  }
  
  handleStateChanged(event) {
    const { changes, state } = event.detail;
    this.synchronizeUIWithState(state, changes);
  }
  
  synchronizeUIWithState(state, changes = null) {
    // VÃ©rifier les propriÃ©tÃ©s critiques et les synchroniser avec l'UI
    this.ensureInterpretationPanelVisibility();
    
    // Synchroniser d'autres Ã©lÃ©ments d'interface selon les besoins
    this.updateStatusIndicators(state);
  }
}
```

### AppController

Le `AppController` coordonne les interactions entre les diffÃ©rents composants :

```javascript
class AppController {
  constructor(stateManager) {
    this.stateManager = stateManager;
    
    // Services
    this.aiService = null;
    this.deckService = null;
    this.uiService = null;
    
    // ContrÃ´leurs
    this.readingController = null;
    this.configController = null;
    
    // Ã‰couter les changements d'Ã©tat pour mettre Ã  jour l'UI
    this.stateManager.subscribe(this.handleStateChange.bind(this));
    
    // Synchroniser l'UI avec l'Ã©tat restaurÃ©
    this.syncUIWithState();
  }
  
  handleStateChange(state) {
    // Mettre Ã  jour le titre du document en fonction du type de tirage
    let title = 'JodoTarot';
    
    switch (state.spreadType) {
      case 'cross':
        title += ' - Tirage en Croix';
        break;
      case 'horseshoe':
        title += ' - Tirage en Fer Ã  Cheval';
        break;
      case 'love':
        title += ' - Tarot de l\'Amour';
        break;
      case 'celticCross':
        title += ' - Croix Celtique';
        break;
    }
    
    document.title = title;
    
    // Mettre Ã  jour la visibilitÃ© des messages d'erreur
    if (state.error) {
      this.showError(state.error);
    }
    
    // Afficher/masquer le spinner de chargement
    this.updateLoadingState(state.isLoading);
  }
}
```

### ConfigController

Le `ConfigController` gÃ¨re les interactions de configuration :

```javascript
class ConfigController {
  constructor(stateManager, aiService, uiService) {
    this.stateManager = stateManager;
    this.aiService = aiService;
    this.uiService = uiService;
    
    // Ã‰lÃ©ments DOM
    this.elements = {
      languageSelect: document.getElementById('language'),
      personaSelect: document.getElementById('persona'),
      cardSetSelect: document.getElementById('card-set'),
      spreadTypeSelect: document.getElementById('spread-type'),
      iaModelSelect: document.getElementById('ia-model'),
      appTitle: document.getElementById('app-title'),
      personaLogo: document.getElementById('persona-logo'),
      warningContainer: document.getElementById('connectivity-warning') || this.createWarningContainer()
    };
    
    // Initialiser les Ã©couteurs d'Ã©vÃ©nements
    this.initEventListeners();
    
    // S'abonner aux changements d'Ã©tat pour maintenir l'UI synchronisÃ©e
    this.stateManager.subscribe((newState, changes = {}) => {
      this.syncUIWithState();
      
      // Traitements spÃ©cifiques
      if (changes.language) {
        this.updateUILanguage(newState.language);
      }
      if (changes.spreadType) {
        this.updateAppTitle();
      }
      if (changes.iaModel) {
        this.testModelConnectivity();
      }
    });
    
    // Ã‰couter l'Ã©vÃ©nement spÃ©cifique pour la mise Ã  jour du menu dÃ©roulant des modÃ¨les IA
    document.addEventListener('iaModelUI:update', (event) => {
      this.updateModelSelectUI(event.detail.model);
    });
  }
}
```

## Ã‰tats d'Interface

### SchÃ©ma d'Ã‰tat UI

L'Ã©tat de l'interface est gÃ©rÃ© via le StateManager avec les propriÃ©tÃ©s suivantes :

```javascript
{
  isLoading: {
    type: 'boolean',
    default: false
  },
  error: {
    type: 'string',
    nullable: true,
    default: null
  },
  isCardEnlarged: {
    type: 'boolean',
    default: false
  },
  enlargedCardId: {
    type: 'number',
    nullable: true,
    default: null
  },
  modelStatus: {
    type: 'object',
    description: 'Ã‰tat actuel du modÃ¨le d\'IA',
    default: {
      isLoading: false,
      isConnected: false,
      error: null,
      lastCheck: null
    }
  },
  availableModels: {
    type: 'object',
    description: 'Liste des modÃ¨les disponibles par type',
    default: {
      ollama: [],
      openai: [
        'gpt-3.5-turbo',
        'gpt-4',
        'gpt-4o',
        'gpt-4o-mini'
      ]
    }
  }
}
```

### Gestion des Ã‰tats de Chargement

```javascript
// Exemple de gestion d'Ã©tat de chargement dans le ConfigController
async handleModelChange(event) {
  const model = event.target.value;
  try {
    // Commencer le chargement
    this.stateManager.setState({ 
      modelStatus: { 
        isLoading: true,
        isConnected: false,
        error: null 
      } 
    });
    
    // VÃ©rifier la connectivitÃ©
    const testResult = await this.testModelConnectivity(model);
    
    // Mettre Ã  jour l'Ã©tat avec le rÃ©sultat
    this.stateManager.setState({ 
      iaModel: model,
      modelStatus: { 
        isLoading: false,
        isConnected: testResult.success,
        error: testResult.success ? null : testResult.message,
        lastCheck: new Date().toISOString()
      } 
    });
  } catch (error) {
    this.stateManager.setState({ 
      modelStatus: { 
        isLoading: false,
        isConnected: false,
        error: error.message 
      } 
    });
  }
}
```

## Ã‰vÃ©nements PersonnalisÃ©s

### Ã‰vÃ©nements SystÃ¨me

- `stateManager:ready` : Ã‰tat initialisÃ©
- `stateManager:error` : Erreur de gestion d'Ã©tat
- `state:changed` : Changement d'Ã©tat global
- `iaModelUI:update` : Mise Ã  jour UI du modÃ¨le IA

### Ã‰vÃ©nements de Cartes

- `card:selected` : Carte sÃ©lectionnÃ©e
- `card:deselected` : Carte dÃ©sÃ©lectionnÃ©e
- `card:flip:start` : DÃ©but d'animation de retournement
- `card:flip:end` : Fin d'animation de retournement
- `deckId:changed` : Changement de jeu de cartes

### Ã‰vÃ©nements de Tirage

- `spread:card:placed` : Carte placÃ©e dans le tirage
- `spread:complete` : Tirage complÃ©tÃ©

## Synchronisation UI/Ã‰tat

### Principe de Base

1. L'Ã©tat est la source unique de vÃ©ritÃ©
2. Les changements d'Ã©tat dÃ©clenchent des mises Ã  jour UI
3. Les interactions UI mettent Ã  jour l'Ã©tat
4. L'Ã©tat met Ã  jour l'UI via les Ã©couteurs

### Exemple de Flux

```javascript
// 1. Interaction utilisateur - Exemple de changement de langue
languageSelect.addEventListener('change', (event) => {
  const language = event.target.value;
  
  // 2. Mise Ã  jour de l'Ã©tat
  this.stateManager.setState({ language });
});

// 3. Ã‰couteur d'Ã©tat dans ConfigController
this.stateManager.subscribe((newState, changes = {}) => {
  // 4. RÃ©actions aux changements spÃ©cifiques
  if (changes.language) {
    this.updateUILanguage(newState.language);
  }
});
```

## Notifications et Retours Utilisateur

### Affichage des Erreurs

Le UIService fournit des mÃ©thodes pour afficher des notifications et erreurs:

```javascript
showError(message, isApi = false, duration = 5000) {
  // CrÃ©er/rÃ©cupÃ©rer le conteneur d'erreur
  let errorContainer = document.querySelector('.error-container');
  if (!errorContainer) {
    errorContainer = document.createElement('div');
    errorContainer.className = 'error-container';
    document.body.appendChild(errorContainer);
  }
  
  // CrÃ©er le message d'erreur
  const errorElement = document.createElement('div');
  errorElement.className = `error-message ${isApi ? 'api-error' : ''}`;
  errorElement.textContent = message;
  
  // Ajouter au conteneur
  errorContainer.appendChild(errorElement);
  
  // Animation et disparition automatique
  setTimeout(() => {
    errorElement.classList.add('visible');
  }, 10);
  
  if (duration > 0) {
    setTimeout(() => {
      errorElement.classList.remove('visible');
      setTimeout(() => errorElement.remove(), 300);
    }, duration);
  }
  
  return errorElement;
}
```

### Notifications Temporaires

```javascript
showNotification(message, type = 'info', duration = 3000) {
  let container = document.getElementById('toast-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'toast-container';
    container.style.position = 'fixed';
    container.style.top = '20px';
    container.style.right = '20px';
    container.style.zIndex = '10000';
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    container.style.gap = '10px';
    document.body.appendChild(container);
  }
  
  const toast = document.createElement('div');
  toast.className = 'toast notification-' + type;
  toast.innerText = message;
  toast.style.opacity = '0';
  toast.style.transition = 'opacity 0.5s ease';
  container.appendChild(toast);
  
  // Animation et disparition automatique
  void toast.offsetWidth;
  toast.style.opacity = '1';

  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 500);
  }, duration);
}
```

## Bonnes Pratiques

1. **Gestion d'Ã‰tat**
   - Utiliser le StateManager pour toutes les modifications d'Ã©tat
   - Valider les donnÃ©es avant mise Ã  jour
   - Maintenir la cohÃ©rence de l'Ã©tat

2. **Ã‰vÃ©nements**
   - Utiliser les Ã©vÃ©nements personnalisÃ©s pour la communication
   - Nettoyer les Ã©couteurs inutilisÃ©s
   - Ã‰viter la propagation excessive d'Ã©vÃ©nements

3. **Performance**
   - DÃ©bouncer les Ã©vÃ©nements frÃ©quents
   - Optimiser les mises Ã  jour UI
   - Ã‰viter les calculs inutiles

4. **AccessibilitÃ©**
   - Maintenir une navigation clavier cohÃ©rente
   - Fournir des annonces appropriÃ©es
   - Respecter les standards ARIA

## Ressources

- [Guide d'AccessibilitÃ©](https://www.w3.org/WAI/ARIA/apg/)
- [Patterns d'Interaction](https://www.patterns.dev/)
- [Tests d'Interface](https://testing-library.com/) 